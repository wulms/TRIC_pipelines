---
title: "dwi"
author: "Niklas Wulms"
date: "7/15/2020"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

Always start R/Rstudio from the Terminal - so that is has access to fsl. Otherwise no processing happens.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(doParallel)
library(foreach)
library(oro.nifti)
library(neurobase)
library(xml2)
library("XML")


source("dwi_functions.R")

# parallelization option
cores_not_to_use = 1
```


## Input files

```{r}
# this folder needs a subfolder "sourcedata" containing data in BIDS specification 
# and a folder "params" with "acqparams.txt and index.txt

## tric data
BIDS_folder <- "../data/data_tric/bids" # take care - should end without the last "/"
subject_id <- "sub-(AD|ADHC|BRP|BRPHC)[:digit:]{5}/"

## bidirect data
# BIDS_folder <- "../data/data_bidirect/bids/" # take care - should end without the last "/"
# subject_id <- "sub-[:digit:]{5}/"


BIDS_folder <- normalizePath(BIDS_folder)


# this file is in FSL folder!
b02b0_cnf <- "/usr/local/fsl/src/topup/flirtsch/b02b0.cnf"

source("filenames/filenames.R", local = TRUE)

topup = "off" # sets topup "on" or "off"

```


# Preparing

Calculate index.txt, if it does not exist

```{r}
path_to_folder(index)

# Create Index file if it does not exists
if(!file.exists(index)){
  dwi_length_bvals <- dwi_bval[1] %>% 
    read.table(header = FALSE, sep = "", dec = ".") %>% 
    length()
  
  index_txt <- rep(1, dwi_length_bvals)
  write_lines(x = index_txt, 
              file = index, 
              sep = " ")
  
  index %>% read.table(header = FALSE, sep = "", dec = ".")
}
```

acqparams.txt

this file is sequence and user specific and needs to be added manually!

needs to be in the bids/derived/TRIC_dwi_pipeline/params folder

```{r}
acqparams %>% read.table(header = FALSE, sep = "", dec = ".")

```

## DWI preprocessing

```{r}
source("methods/0_dwi_preprocessing.R")
```

```{r}
source("methods/1_dti_processing.R")
```


# TBSS Processing

## indexing

```{r}
source("filenames/filenames_tbss.R")
```


# TBSS like pipeline

## tbss FA

## tbss non-FA: MD

FA/stats/ copy 

- /TBSS
  -/FA
    -/FA
    -/orig
    -/stats
  -/MD
  -/L
  
-FA/FA und FA/stats

/new_nonFA/
  -/TBSS
    -/FA
    -/stats
    -/MD
    -/L
    -/RD (wird aus L errechnet)
    
    
```{r}
source("methods/2_dti_nonFA_processing.R")
```
    





# ROI extraction





```{r}
source("filenames/filenames_extraction.R")
```

```{r}
# inputs
atlas <- "/usr/local/fsl/data/atlases/JHU/JHU-ICBM-labels-1mm.nii.gz" # exact path to atlas
label_file <- "/usr/local/fsl/data/atlases/JHU-labels.xml" # exact path to labels to atlas

atlas_prefix <- "JHU" # custom label of the atlas.
```

```{r}
source("methods/4_md_fa_extraction.R")
```


```{r}
subject_string = str_remove(subject_id, "/")

subject_ids = list.files(paste0(output_tbss_nonfa, "/origdata")) %>%
  str_extract(pattern = subject_string)

a <- read.table(merged_df$files[52], header = FALSE, col.names = c("mean", "sd"), row.names = subject_ids) %>%
  select(mean)

read.table(merged_df$files[52], header = FALSE, col.names = c("mean", "sd"), row.names = subject_ids) %>%
  select(sd)

```

```{r}
merged_df_test <- merged_df %>%
  filter(txt_type == "meantstats")


dataframes <- lapply(merged_df_test$files, read.table, 
         header = FALSE, col.names = c("mean", "sd"))


merged_df_test %>% cbind(dataframes)


merged_df_test %>%
  mutate(table = lapply(files, read.table, header = FALSE, col.names = c("mean", "sd"), row.names = subject_ids),
         table = map(table,
                      ~ mutate(.x,
                               id = subject_ids)
                      )) %>%
  unnest(table) %>%
  select(-files, -filename, -txt_type) %>%
  relocate(id) %>%
  pivot_wider(names_from = c("type", "roinum", "roi"),
              values_from = c("mean", "sd"))
```







# GLM Analysis

glmgui: "Glm"

\#GLM Design definieren.

```{r}
stats_nonfa_directory <- paste0(output_tbss_nonfa, "/stats")

tbss_all(input_directory = stats_nonfa_directory,
         input_command = "randomise -i all_FA_skeletonised -o tbss -m mean_FA_skeleton_mask -d design.mat -t design.con -n 500 --T2 -V")


randomise_fa_in <- list.files(stats_nonfa_directory, "^tbss", full.names = TRUE)
randomise_fa_out <- str_replace(randomise_fa_in, "nonFA/tbss/stats/tbss", "randomise/FA/tbss") 
path_to_folder(randomise_fa_out)
file.rename(randomise_fa_in, randomise_fa_out)
```

```{r}
tbss_all(input_directory = stats_nonfa_directory,
         input_command = "randomise -i all_MD_skeletonised -o tbss -m mean_FA_skeleton_mask -d design.mat -t design.con -n 500 --T2 -V")

randomise_fa_in <- list.files(stats_nonfa_directory, "^tbss", full.names = TRUE)
randomise_fa_out <- str_replace(randomise_fa_in, "nonFA/tbss/stats/tbss", "randomise/MD/tbss") 
path_to_folder(randomise_fa_out)
file.rename(randomise_fa_in, randomise_fa_out)
```


```{r}
tbss_all(input_directory = stats_nonfa_directory,
         input_command = "randomise -i all_RD_skeletonised -o tbss -m mean_FA_skeleton_mask -d design.mat -t design.con -n 500 --T2 -V")

randomise_fa_in <- list.files(stats_nonfa_directory, "^tbss", full.names = TRUE)
randomise_fa_out <- str_replace(randomise_fa_in, "nonFA/tbss/stats/tbss", "randomise/RD/tbss") 
path_to_folder(randomise_fa_out)
file.rename(randomise_fa_in, randomise_fa_out)
```

```{r}
tbss_all(input_directory = stats_nonfa_directory,
         input_command = "randomise -i all_AD_skeletonised -o tbss -m mean_FA_skeleton_mask -d design.mat -t design.con -n 500 --T2 -V")

randomise_fa_in <- list.files(stats_nonfa_directory, "^tbss", full.names = TRUE)
randomise_fa_out <- str_replace(randomise_fa_in, "nonFA/tbss/stats/tbss", "randomise/AD/tbss") 
path_to_folder(randomise_fa_out)
file.rename(randomise_fa_in, randomise_fa_out)
```




\#randomise -i \<4D_input_data\> -o <output_rootname> -d design.mat -t
design.con -m <mask_image> -n 500 -D -T

```{r}
command14 <- paste0("tbss_fill", tbss_clustere_corrp_tstat1,
                    " 0.949",  mean_FA, tbss_clustere_corrp_tstat1_filled)
print(command14)
lapply(command14, system)
```

\#tbss_fill tbss_clustere_corrp_tstat1 0.949 mean_FA
tbss_clustere_corrp_tstat1_filled
